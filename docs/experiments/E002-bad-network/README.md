## Запуск экспериментов и получение сырых данных

Данный раздел описывает порядок подготовки системы и запуска экспериментальных сценариев для получения сырых данных (fio JSON, сетевые и системные логи).

Эксперименты предполагают, что USB-накопитель **экспортируется по USB/IP** и используется как удалённое блочное устройство.

---

### 1. Подключение USB-устройства через USB/IP

На клиентской машине убедитесь, что устройство подключено и отображается как блочное:

```bash
lsblk
```

Ожидается наличие устройства вида `/dev/sdX`.

---

### 2. Очистка mountpoint

Перед каждым экспериментом необходимо убедиться, что mountpoint чистый и не содержит старых монтирований.

```bash
sudo umount /mnt/usb || sudo umount -l /mnt/usb
mount | grep /mnt/usb || echo OK
```

Команда должна вывести `OK`.

---

### 3. Монтирование актуального устройства

Монтируется **только текущее USB-устройство**, используемое в эксперименте.

```bash
sudo mount /dev/sdc1 /mnt/usb
mount | grep /mnt/usb
```

Убедитесь, что в выводе присутствует ровно одна строка с `/mnt/usb`.

---

### 4. Проверка возможности записи (write-test)

Перед запуском нагрузки необходимо убедиться, что файловая система доступна для записи.

```bash
sudo sh -c "echo test > /mnt/usb/.write_test && sync && rm -f /mnt/usb/.write_test"
```

Команда должна завершиться без ошибок.

---

### 5. Запуск baseline-профиля

Перед запуском эксперимента обновляем sudo-сессию:

```bash
sudo -v
```

Запуск baseline-профиля (без деградации сети):

```bash
./scripts/40_run_matrix.sh profiles/baseline.env
```

В этом режиме:

- сетевые условия не ухудшаются,
    
- формируется базовая линия (baseline),
    
- результаты используются для сравнения с деградированными профилями.
    

---

### 6. Запуск экспериментов с деградацией сети

Для запуска полного набора профилей:

```bash
./scripts/40_run_matrix.sh profiles
```

Или для запуска конкретного профиля:

```bash
./scripts/40_run_matrix.sh profiles/delay_80ms.env
```

Каждый профиль:

- применяет `tc netem` на клиенте,
    
- запускает одинаковый набор fio-тестов,
    
- сохраняет сырые артефакты (fio JSON, логи, preflight).
    

---

### 7. Результаты выполнения

После завершения эксперимента формируется каталог с результатами, содержащий:

- JSON-результаты fio,
    
- логи применения и снятия netem,
    
- системные снимки (ss, nstat),
    
- метаданные профиля.
    

Эти данные используются для последующей агрегации и построения графиков.

---

## Агрегация результатов и построение графиков

После завершения одного или нескольких экспериментальных прогонов необходимо агрегировать сырые данные и сформировать графики для анализа.

### 8. Агрегация сырых данных

Для агрегации используется скрипт `aggregate_usbip.py`, который собирает результаты fio и сопутствующие артефакты в нормализованные таблицы.

Пример запуска:

```bash
python aggregate_usbip.py --root ./results --out ./out
```

В результате формируются следующие файлы:

- `out/profile_table.csv` — параметры сетевых профилей и окружения (1 строка = 1 профиль),
    
- `out/fio_table.csv` — результаты fio (1 строка = профиль × workload),
    
- `out/net_table.csv` — сетевые и TCP-метрики,
    
- `out/summary.csv` — объединённая таблица для анализа и визуализации.
    

---

### 9. Построение графиков

Для визуализации агрегированных данных используется скрипт `plot_usbip.py`.

Запуск:

```bash
python plot_usbip.py --summary ./out/summary.csv --out ./out
```

После выполнения скрипта в каталоге `out/plots/` будут сформированы графики:

- `iops_vs_delay_log.png` — зависимость IOPS от сетевой задержки,
    
- `bw_vs_delay_log.png` — пропускная способность vs задержка,
    
- `total_ios_vs_delay_log.png` — фактический прогресс операций,
    
- `tail_latency_*.png` — p50/p95/p99/p99.9 latency для каждого workload,
    
- `slat_clat_mean_*.png` — разложение latency на slat и clat.
    

Все графики строятся в логарифмической шкале, что позволяет наглядно выявлять деградацию и хвостовые задержки.

---

### 10. Использование результатов

Сформированные таблицы и графики используются для:

- анализа влияния сетевой задержки на USB/IP,
    
- выявления backpressure и tail latency,
    
- прямого сравнения с экспериментами USB-over-QUIC,
    
- подготовки отчётов, документации и материалов для защиты.